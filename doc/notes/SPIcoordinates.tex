\documentclass{notes}

\title{Geometrical considerations for the SPI module}
\author{Mathias Hoppe and Oskar Vallhagen}


\begin{document}
    \maketitle

    \noindent
    In this document we consider the geometry used to track pellet shards in the
    SPI module of \DREAM, and how that geometry relates to the magnetic field
    geometry used elsewhere in \DREAM.

    The SPI module uses a cartesian coordinate system with origin on the
    magnetic axis. The coordinate system is oriented such that the $z$ direction
    is parallel to the toroidal direction in $x=y=0$, as illustrated in
    figure~\ref{fig:geom}.

    \begin{figure}
        \centering
        \includegraphics[width=0.5\textwidth]{figs/SPIgeom.pdf}
        \caption{
            Illustration of the coordinate system used for the SPI module in
            \DREAM.
        }
        \label{fig:geom}
    \end{figure}

    \section{Coordinate transformations}
    In the SPI module, it is necessary to map the cartesian coordinates
    $(x,y,z)$ of the points in space to the corresponding flux surface label
    $r$. In the toroidal case, this requires a two-step procedure where the
    cartesian coordinates $(x,y,z)$ are first transformed to their corresponding
    cylindrical $(R,Z,\varphi)$ or toroidal coordinates $(\rho,\theta,\varphi)$.
    In the second step, the cylindrical or toroidal coordinates must then be
    inverted to obtain the flux surface label $r$, and this generally requires
    numerical root-finding.

    \subsection{Cylindrical coordinates}
    The transformation to cylindrical coordinates is straightforward: since
    $x$ and $z$ lie in the horizontal plane, while $y$ is always vertical, the
    major radius and vertical position $Z$ is given by
    \begin{subequations}
        \begin{align}
        R &= \sqrt{(x+R_0)^2 + z^2},\\
        Z &= y.
        \end{align}
    \end{subequations}

    \subsection{Toroidal coordinates}
    To obtain the toroidal coordinates $\rho$ and $\theta$, we first introduce
    the position vector $\vec{r} = (x+R_0,y,z)$, defined to originate in $y=0$
    on the axis of symmetry of the tokamak (the red dot in
    figure~\ref{fig:geom}). We then introduce the unit vector
    \begin{equation}
        \hat{r} = \frac{\left(\vec{r}\cdot\hat{x}\right)\hat{x} + \left(\vec{r}\cdot\hat{z}\right)\hat{z}}
        {\sqrt{\left(\vec{r}\cdot\hat{x}\right)^2 + \left(\vec{r}\cdot\hat{z}\right)^2}} =
        %
        \frac{(x+R_0)\hat{x} + z\hat{z}}{\sqrt{(x+R_0)^2+z^2}},
    \end{equation}
    which is the normalized projection of the position vector $\vec{r}$ to the
    horizontal plane. With these vectors, we can then obtain the minor radius
    vector $\vec{\rho}$ as
    \begin{equation}
        \vec{\rho} = \vec{r}-R_0\hat{r} =
        \left(x+R_0-\frac{(x+R_0)R_0}{\sqrt{\left(x+R_0\right)^2 + z^2}}\right)\hat{x}
        + y\hat{y}
        + \left(z-\frac{zR_0}{\sqrt{\left(x+R_0\right)^2 + z^2}}\right)\hat{z},
    \end{equation}
    and the magnitude of this vector is
    \begin{equation}
        \rho = \sqrt{
            \left(x+R_0-\frac{(x+R_0)R_0}{\sqrt{\left(x+R_0\right)^2 + z^2}}\right)^2
            + y^2
            + \left(z-\frac{zR_0}{\sqrt{\left(x+R_0\right)^2 + z^2}}\right)^2
        }.
    \end{equation}
    Knowing the minor radius $\rho$ corresponding to $(x,y,z)$ will get us only
    part of the way to determining the flux surface radius $r$. To fully
    determine it, we also need to know the poloidal angle $\theta$ of the
    cartesian coordinates. In numerical geometry, this is easy to obtain from
    the minor radius vector $\vec{\rho}$. By the definition of the poloidal
    angle $\theta$ in numerical toroidal geometry, we have
    \begin{equation}
        \tan\theta = \frac{\left(\vec{\rho}\cdot\hat{y}\right)\mathrm{sgn}\left(R-R_0\right)}
            {\sqrt{\left(\vec{\rho}\cdot\hat{x}\right)^2 + \left(\vec{\rho}\cdot\hat{z}\right)^2}}
        %
        = \frac{y\,\mathrm{sgn}\left(R-R_0\right)}{\sqrt{
            \left(x+R_0-\frac{(x+R_0)R_0}{\sqrt{\left(x+R_0\right)^2 + z^2}}\right)^2
            + \left(z-\frac{zR_0}{\sqrt{\left(x+R_0\right)^2 + z^2}}\right)^2
        }},
    \end{equation}
    with
    \begin{equation}
        R = \sqrt{(x+R_0)^2+z^2}.
    \end{equation}
    The sign function appears since
    $\sqrt{(\vec{\rho}\cdot\hat{x})^2 + (\vec{\rho}\cdot\hat{z})^2}$
    should correspond to the horizontal cartesian coordinate in the poloidal
    plane (which is negative in the second and third quadrants).
    
    \section{Cylindrical coordinates to analytic B}
    The conversion from cartesian coordinates to flux surface coordinates in the analytical B-field geometry in DREAM is most easily done via a transformation to cylindrical coordinates. The reason for this is that the poloidal angle $\theta$ does not have a simple geometrical definition in this context.
    
    The flux surface geometry in the analytic B mode is related to the cylindrical coordinates according to
    \begin{align}
R &= R_0 + \Delta(r) + r\cos[\theta +\delta(r) \sin\theta], \nonumber \\
Z &= r \kappa(r) \sin\theta,
\label{eq:analyticB system}
\end{align}
where $\kappa$ is the elongation, $\Delta$ the Shafranov shift and $\delta$ a triangularity parameter. We solve this equation system by eliminating the $\theta$-dependence from the equation for $R$ using the equation for $Z$, and in that way obtain an equation for $r$ alone which is straightforward to solve numerically. First, we rewrite the equation for $R$ in terms of $\cos{\theta}$ and $\sin{\theta}$ rather than $\theta$ itself:
	\begin{equation}
		R = R_0 + \Delta (r) + r[\cos{\theta}\cos{(\delta(r)\sin{\theta})} - \sin{\theta}\sin{(\delta(r)\sin{\theta})}].
		\label{eq:RAnalyticB}
	\end{equation}
	From the equation for $Z$, we have
	\begin{align}
		\sin{\theta} &= \frac{Z}{r\kappa(r)}\nonumber \\
		\cos{\theta} &= \pm \sqrt{1-\left(\frac{Z}{r\kappa(r)}\right)^2}.
		\label{eq:SinCosAnalyticB}
	\end{align}
	It remains now to determine the sign on $\cos{\theta}$. We do this by calculating the major radius $R_\mathrm{crit}$ where $\cos{\theta}=0$. As the major radius is a monotonically increasing function of $\cos{\theta}$ {\color{red}(which it always is, right?)}, if $R>R_\mathrm{crit}$, $\cos{\theta}>0$, and vice versa. The critical major radius is calculated by noting that when $\cos{\theta}=0$, we have $\sin{\theta}=1$, so that
	\begin{equation}
		R_\mathrm{crit} = R_0 + \Delta(r_\mathrm{min}) - r_\mathrm{min}\sin{(\delta(r_\mathrm{min}))},
	\end{equation}
	where $r_\mathrm{min}$ is calculated (numerically) from
	\begin{equation}
		Z = r_\mathrm{min}\kappa(r_\mathrm{min}).
	\end{equation}
	With the sign of $\cos{\theta}$ known, we can finally obtain an equation with $r$ as the only unknown by inserting equation \eqref{eq:SinCosAnalyticB} into equation \eqref{eq:RAnalyticB}. As the derivative of this equation with respect to $r$ diverges at $r=r_\mathrm{min}$, it is probably best to solve this equation using a bisection method rather than a Newton method.
	

    
\end{document}
