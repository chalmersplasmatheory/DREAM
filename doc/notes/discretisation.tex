\documentclass{notes}

\title{Discretisation of position and momentum}
\author{}

\usepackage{amssymb}
\usepackage{hyperref}
\usepackage[
    backend=biber,
    sorting=none,
    style=numeric-comp,
    citestyle=numeric-comp
]{biblatex}
\addbibresource{ref.bib}

\newcommand{\FVM}{\textsc{Fvm}}
\newcommand{\nRE}{n_{\rm RE}}
\newcommand{\Vp}{\mathcal{V}'}
\newcommand{\Jac}{\mathsf{J}}

\begin{document}
    \maketitle

    \noindent
    This document describes the (spatial/momentum) discretisations used in \DREAM.
    The overarching scheme used for deriving discretisations is the so-called
    finite-volume method (FVM).

    \tableofcontents

    \section{Grid definition}
    The most general grid used in \DREAM\ consists of three coordinates: one
    spatial coordinate $x$ and two momentum coordinates, $p_1$ and $p_2$. For
    a general coordinate $z^{(\alpha)}$, we introduce $N_\alpha$ cell grid points and
    $N_\alpha+1$ flux grid points and impose the definitions
    \begin{equation}
        \begin{aligned}
            \text{Flux grid:} & \qquad z^{(\alpha)}_{\rm min} = z^{(\alpha)}_{1/2} < z^{(\alpha)}_{3/2} < \ldots < z^{(\alpha)}_{N_\alpha+1/2} = z^{(\alpha)}_{\rm max},\\
            \text{Cell grid:} & \qquad z^{(\alpha)}_i = \frac{z^{(\alpha)}_{i+1/2} + z^{(\alpha)}_{i-1/2}}{2}, \quad (1\leq i \leq N_\alpha)\\
            &\qquad \Delta z^{(\alpha)}_i = z^{(\alpha)}_{i+1/2} - z^{(\alpha)}_{i-1/2}, \quad (1\leq i \leq N_\alpha)\\
            &\qquad \Delta z^{(\alpha)}_{i-1/2} = z^{(\alpha)}_i - z^{(\alpha)}_{i-1},\quad (2\leq i \leq N_\alpha).
        \end{aligned}
    \end{equation}

    \section{Boundary conditions}
    This section describes the various boundary conditions used in the code.
    In momentum space, the internal boundary conditions can be described from
    the distribution function symmetry relations
    \begin{equation}\label{eq:fsymmetry}
        \begin{aligned}
            f(-p,\theta) &= f(p,\pi-\theta),\\
            f(p,-\theta) &= f(p,\theta).
        \end{aligned}
    \end{equation}

    \subsection{Boundary conditions on $p/\xi$ grids}
    From the first of the symmetry relations~\eqref{eq:fsymmetry}, we find that
    that the flux through $p=0$ along a given pitch direction must be equal on
    both sides, implying that
    \begin{equation}
        \Phi^{(p)}\left(p=0^+, \xi\right) = \Phi^{(p)}\left(p=0^-, -\xi\right).
    \end{equation}

    From the second of the symmetry relations~\eqref{eq:fsymmetry}, we
    immediately find that the fluxes across the $\xi=\pm1$ boundaries vanish,
    i.e.\
    \begin{equation}\label{eq:bc:xiInternal}
        \Phi^{(\xi)}(p, \xi=1) = \Phi^{(\xi)}(p, \xi=-1) = 0.
    \end{equation}

    For external boundary conditions, we need to consider two cases. In the
    first case, the region above $p=p_{\rm max}$ is modelled as a fluid, and we
    thus only count the radial density $\nRE$ of runaway electrons. This
    means that we must count the flux through the $p=p_{\rm max}$ boundary, so
    that
    \begin{equation}
        \frac{\partial \nRE}{\partial t} =
        \int_{-1}^1 \Phi^{(p)}\left(p_{\rm max}, \xi\right)\,\frac{\Vp(r,p_{\rm max},\xi)}{V'(r)}\,\dd\xi.
    \end{equation}
    To evaluate $\Phi^{(p)}(p_{\rm max},\xi)$, which results from a combination
    of advection and diffusion on the momentum grid, we generally need to know
    the distribution function $f$ on both sides of $p=p_{\rm max}$. Since we do
    not keep track of $f$ above $p=p_{\rm max}$, we will need handle this in a
    special way. For the advection term, we simply set the interpolation
    coefficient $\delta_{N_p+1} = 0$, so that only the value of $f$ in
    $p=p_{N_p-1/2}$ is used. This could potentially cause problems with
    the preservation of positivity, and \red{we might want to consider other
    methods in the future.} For the diffusion term, however, no such simple fix
    exists, and we instead choose to interpolate in the flux:
    \begin{equation}
        \begin{aligned}
            \Phi^{(p)}_{N_p-1/2} &= \Phi^{(p)}_{N_p+1/2} - \Delta p_{N_p}\Phi^{\prime(p)}_{N_p+1/2},\\
            \Phi^{(p)}_{N_p-3/2} &= \Phi^{(p)}_{N_p+1/2} - (\Delta p_{N_p}+\Delta p_{N_p-1})
            \Phi^{\prime(p)}_{N_p+1/2},
        \end{aligned}
    \end{equation}
    where $\Phi^{\prime(p)} = \partial\Phi^{(p)}/\partial p$. Solving for
    $\Phi^{(p)}_{N_p+1/2}$ we obtain
    \begin{equation}
        \Phi^{(p)}_{N_p+1/2} = \Phi^{(p)}_{N_p-1/2} +
        \frac{\Delta p_{N_p}}{\Delta p_{N_p-1}} \left( \Phi^{(p)}_{N_p-1/2} - \Phi^{(p)}_{N_p-3/2} \right).
    \end{equation}

    In the second case, when the runaway grid is enabled, we want the flux
    across the hot-tail $p=p_{\rm max}$ to enter (or leave) the runaway grid
    seamlessly. If the hot-tail and runaway grids have the same $\xi$ grids,
    this is rather straightforward as we simply set 
    $\Phi^{(p)}_{\rm hot}(p_{\rm max},\xi) = \Phi^{(p)}_{\rm RE}(p_{1/2},\xi)$.
    However, in \DREAM, we allow for the two grids to be different (we only
    enforce $p^{\rm RE}_{1/2} = p^{\rm hot}_{\rm max}$) and so we must connect
    the two grids in some way. To conserve particles, we require that the
	number of particles added to the runaway (RE) grid are also removed from
	the hot-tail grid. Specifically,
	\begin{equation}\label{eq:fluxCross_origin}
		\begin{gathered}
			-\int \left[\nabla\cdot\bb{\Phi}\right]^{\rm RE}_{1,J}\,\Vp^{\rm RE}_{1,J}\dd p\,\dd\xi =
			\int \left[\nabla\cdot\bb{\Phi}\right]^{\rm hot}_{N_p,j}\,\Vp^{\rm hot}_{N_p,j}\dd p\,\dd\xi,\\
			\implies\\
			%
			-\frac{\Vp^{\rm RE}_{1/2,J}\Phi^{\rm RE}}{\Vp^{\rm RE}_{1,J}\Delta p^{\rm RE}_1}\Vp^{\rm RE}_{1,J}\Delta p^{\rm RE}_1 \Delta\xi^{\rm RE}_J =
			\sum_j\frac{\Vp^{\rm hot}_{N_p+1/2,j}\Phi^{\rm hot}}{\Vp^{\rm hot}_{N_p,j}\Delta p^{\rm hot}_{N_p}}\Vp^{\rm hot}_{N_p,j}\Delta p^{\rm hot}_{N_p} \overline{\Delta\xi}_{jJ},
		\end{gathered}
	\end{equation}
	where $\overline{\Delta\xi}_{jJ}$ is
    \begin{equation}\label{eq:PhiPinterp}
        \overline{\Delta\xi}_{jJ,\rm hot} = \min\left(\xi_{J+1/2,{\rm hot}},\xi_{j+1/2,{\rm RE}}\right) -
        \max\left( \xi_{J-1/2,{\rm hot}}, \xi_{j-1/2,{\rm RE}} \right),
    \end{equation}
    so that $\Delta\xi_{j,\rm RE} = \sum\overline{\Delta\xi}_{jJ,\rm hot}$, and
	the sum is taken over all $j$ such that $\xi_j\in[\xi_{J-1/2}, \xi_{J+1/2}]$.
	Simplifying equation~\eqref{eq:fluxCross_origin} we obtain the relation
    \begin{equation}\label{eq:fluxCross}
        -\Phi^{\rm RE}(p_{1/2},\xi_J)\Vp^{\rm RE}_{1/2,J}\Delta\xi^{\rm RE}_{J} =
        \sum_{j} \Phi^{\rm hot}(p_{\rm max},\xi_J) \Vp^{\rm hot}_{N_p+1/2,j} \overline{\Delta\xi}_{jJ},
    \end{equation}
	which must be satisfied for the particle number to be conserved across the
	two grids.

    \section{Spatial discretisations}
    In this section we describe the various discretisations used in \DREAM. We
    however begin by describing the general approach taken to discretising
    equations in the code.

    \subsection{Finite volume method}
    In order to achieve mass conservation, we use the finite-volume method to
    discretise our equations and consider the fluxes between cells on the
    computational grid. For a general flux-conservative term
    $\nabla\cdot\bb{\Phi}$, we take the matrix row corresponding to element
    $i_1\cdots i_D$ ($D$ being the problem dimensionality) of the unknown
    quantity to be
    \begin{equation}
        \left[ \nabla\cdot\bb{\Phi} \right]_{i_1\cdots i_D}  =
            \frac{1}{\Vp_{i_1\cdots i_D}}\sum_\beta \frac{
                \Phi^{(\beta)}_{i_\beta+1/2} \Vp_{i_\beta+1/2} -
                \Phi^{(\beta)}_{i_\beta-1/2} \Vp_{i_\beta-1/2}
            }{\Delta z^{(\beta)}_{i_\beta}},
    \end{equation}
    where $\Vp$ denotes the phase space Jacobian, Greek indices denote the
    coordinate (i.e.\ $z_\alpha, z_\beta, \ldots$), Latin indices denote grid
    points and the matrix indices which are not shifted have been suppressed for
    clarity (i.e.\
    $\Phi^{(\beta)}_{i_\beta+1/2}\equiv\Phi^{(\beta)}_{i_1\cdots i_\beta+1/2\cdots i_D}$).

    \subsection{Advection term}\label{sec:advection}
    A general advection term can be written on the form
    \begin{equation*}
        \nabla\cdot\left( \bb{F} f \right),
    \end{equation*}
    with $\bb{F} = \zhat^{(\alpha)}F^{(\alpha)} + \zhat^{(\beta)}F^{(\beta)}+\ldots$
    denoting the advection coefficient and $f$ the distribution function. For
    momentum-space friction, we discretise such terms according to
    \begin{equation}\label{eq:advection:discr}
        \left[\nabla\cdot\left( \bb{F}f \right) \right]_{i_1\cdots i_D} =
            \frac{1}{\Vp_{i_1\cdots i_D}}\sum_\beta \frac{
                F^{(\beta)}_{i_\beta+1/2}f_{i_\beta+1/2} \Vp_{i_\beta+1/2} -
                F^{(\beta)}_{i_\beta-1/2}f_{i_\beta-1/2} \Vp_{i_\beta-1/2}
            }{\Delta z^{(\beta)}_{i_\beta}},
    \end{equation}
    Since the distribution function is only known on the cell grid, but is here
    required on the flux grid, we must interpolate. We may interpolate linearly in
    $f$ according to
    \begin{equation}
        f_{i_\beta-1/2} = \delta^{(\beta)}_{i_\beta} f_{i_\beta} + \left( 1 - \delta^{(\beta)}_{i_\beta} \right) f_{i_\beta-1},
    \end{equation}
    where the interpolation coefficients $\delta^{(\beta)}_{i_\beta}$ are
    determined with the help of any of the methods described in
    section~\ref{sec:interp}. (Note that unnecessary indices have been
    suppressed, so that really
    $\delta^{(\beta)}_{i_\beta} = \delta^{(\beta)}_{i_1\cdots i_\beta\cdots i_D}$).
    
    DREAM more generally supports interpolation via a general 4-point stencil according to
    \begin{equation}
        f_{i_\beta-1/2} = \sum_{k=0}^3 \delta^{(\beta)}_{i_\beta,k} f_{i_\beta-2+k}.
    \end{equation}
    

    \subsubsection{Boundary conditions on $p/\xi$ grid}
    Internal boundary conditions at $p=p_{1/2}$ must be specified explicitly.
    They must then be inserted appropriately into~\eqref{eq:advection:discr} so
    that
    \begin{equation}
        \left[ \nabla\cdot\left( \bb{F}f \right) \right]_{1,j} = \frac{
            \Vp_{3/2} F_{3/2}^{(p)} f_{3/2} - \Vp_{1/2}\Phi^{(p)}_{1/2}
        }{\Delta p_{1}}
    \end{equation}
    where $\Phi_{1/2}^{(p)}$ is the phase space particle flux into or out of
    the inner boundary. At $\xi=\xi_{1/2}$ and $\xi=\xi_{N_\xi+1/2}$, however,
    we use the result~\eqref{eq:bc:xiInternal} and obtain (for the $\xi$ term)
    \begin{equation}
        \begin{aligned}
            \left[ \nabla\cdot\left( \bb{F} f \right) \right]_{i,1} &=
                \frac{\Vp_{3/2} F^{(\xi)}_{i,3/2} f_{i,3/2}}{\Delta\xi_{1}},\\
            %
            \left[ \nabla\cdot\left( \bb{F} f \right) \right]_{i,N_\xi} &=
                -\frac{\Vp_{N_\xi-1/2} F^{(\xi)}_{i,N_\xi-1/2} f_{i,N_\xi-1/2}}{\Delta\xi_{N_\xi}}.
        \end{aligned}
    \end{equation}

    \paragraph{Combining kinetic grids}
    When combining the hot-tail and runaway grids, we want the particles to flow
    seamlessly from one grid to another across their shared boundary. We can
    achieve this behaviour by first noting that
    \begin{equation}\label{eq:crossCondition}
        \begin{aligned}
            \left[ \nabla\cdot\left( \bb{F}f \right)\right]^{\rm hot}_{N_p,j} &=
                \frac{\Vp^{\rm hot}_{N_p+1/2}\Phi^{(p)}_j - \Vp_{N_p-1/2} F_{N_p-1/2}f_{N_p-1/2}}{\Delta p^{\rm hot}_1},\\
            \left[ \nabla\cdot\left( \bb{F}f \right)\right]^{\rm RE}_{1,J} &=
                \frac{\Vp^{\rm RE}_{3/2} F^{(p)}_{3/2} f_{3/2,J} - \Vp^{\rm RE}_{1/2}\Phi^{(p)}_J}{\Delta p^{\rm RE}_1},
        \end{aligned}
    \end{equation}
    where $\Phi^{(p)}$ denotes the flux across the shared boundary. This flux
    can be determined using equation~\eqref{eq:fluxCross}. Note that the flux
    must be determined separately depending on which of the contributions in
    equation~\eqref{eq:crossCondition} one is caclulating. This is due to that
    we evaluate the flux in different $\xi$ points in the two expressions. In
    the first expression, which describes the change of particles on the
    hot-tail grid, we obtain
    \begin{equation}\label{eq:crossFluxP}
        \Phi^{(p)}_j = F_{N_p+1/2,j}f^{\rm hot}_{N_p+1/2,j} =
            F_{N_p+1/2,j}\left[ \delta_{N_p+1}f^{\rm hot}_{N_p+1,j} + \left( 1-\delta_{N_p+1}\right)f^{\rm hot}_{N_p,j} \right].
    \end{equation}
    The distribution function $f^{\rm hot}_{N_p+1}$ does not explicitly exist in
    the equation system, but rather it should be the value of the distribution
    function in $\xi_j^{\rm hot}$ on the runaway grid. Since the runaway grid
    may have a different $\xi$ grid structure we cannot immediately equate
    $f^{\rm hot}_{N_p+1,j}$ with a value on the runaway grid. Instead, we will
    average $f^{\rm RE}$ along the boundary $\xi_j^{\rm hot}$ and use that
    value for evaluating $\Phi^{(p)}$. This is equivalent to re-defining the
    meaning of the distribution function $f^{\rm RE}$ in the calculation, just
    as we do when introducing the finite volume method in the first place
    (where we average the distribution over an entire grid cell instead).
    With this, we obtain
    \begin{equation}\label{eq:fhotTransf}
        f^{\rm hot}_{N_p+1,j}\Delta\xi_j^{\rm hot} =
            \frac{1}{\Vp^{\rm hot}_{N_p+1/2,j}} \sum_J
                f_{1,J}^{\rm RE} \Vp^{\rm RE}_{1/2,J} \overline{\Delta\xi}_{jJ}^{\rm RE},
    \end{equation}
    where $\overline{\Delta\xi}_{jJ}$ is again defined according
    to~\eqref{eq:PhiPinterp}. Similarly, we obtain for the particle change on
    the runaway grid that
    \begin{equation}\label{eq:crossFlux_fRE0}
        f^{\rm RE}_{0,J}\Delta\xi_J^{\rm RE} =
            \frac{1}{\Vp^{\rm RE}_{1/2,J}} \sum_j
                f_{N_p,j}^{\rm hot} \Vp^{\rm hot}_{N_p+1/2,j} \overline{\Delta\xi}_{jJ}^{\rm hot}.
    \end{equation}

    To ensure particle conservation we must make sure to use the exact same flux
    $\Phi^{(p)}$ on both sides of the boundary. In practice, this is achieved
    using the recipe above, and by using the advection coefficient on one side
    of the boundary. For conservation, it should not matter whether we choose
    $F_{N_p+1/2}^{\rm hot}$ or $F_{1/2}^{\rm RE}$, although the choice may
    impact the physics near the boundary region. In \DREAM, we elect to use
    $F_{N_p+1/2}^{\rm hot}$ for evaluating the flux on both sides of the
    boundary. When evaluating $\Phi^{(p)}$ on the hot-tail grid, this is the
    natural choice, but on the runaway grid we generally do not know the value
    of $F^{\rm hot}_{N_p+1/2}$ in the appropriate $\xi$ points. The workaround
    to this is to average the advection coefficient along the boundary. We will
    now derive the correct averaging expression to use, as well as show that
    the averaging procedure indeed leads to density being conserved.

    The flux due to the advection term can be written
    \begin{equation}
        \Phi_j^{(p),{\rm hot}} = \left( Ff \right)^{\rm hot}_{N_p+1/2,j} = F_{N_p+1/2,j}^{\rm hot} f^{\rm hot}_{N_p+1/2,j}.
    \end{equation}
    As shown above, we must then interpolate across the grids in order to obtain
    $f^{\rm hot}_{N_p+1/2,j}$, and this yields
    \begin{equation}\label{eq:PhiPhot}
        \Phi^{(p),{\rm hot}}_j =
            \left(1-\delta^{\rm hot}_{N_p+1}\right) F^{\rm hot}_{N_p+1/2,j} f_{N_p,j}^{\rm hot} +
            \delta^{\rm hot}_{N_p+1} F^{\rm hot}_{N_p+1/2,j} f_{N_p+1,j}^{\rm hot}.
    \end{equation}
    Since $\delta^{\rm hot}_{N_p+1}$ is an arbitrary interpolation coefficient,
    we are free to consider the two terms separately, and we will do so in what
    follows.

    To evaluate $F^{\rm hot}_{N_p+1/2,j}$ in the $\xi$ grid points of both grids
    (although it is strictly only given on the hot-tail grid) we first use the
    flux balance equation~\eqref{eq:fluxCross} to enforce
    \begin{equation}\label{eq:fluxBalance2}
        \left( F f \right)^{\rm hot}_{N_p+1/2,j} \Delta\xi^{\rm hot}_j\Vp_{N_p+1/2,j} =
        \sum_J \left( F f \right)^{\rm RE}_{1/2,J} \overline{\Delta\xi}^{\rm RE}_{jJ}\Vp^{\rm RE}_{1/2,J},
    \end{equation}
    where the sum over $J$ is taken over all $J$ such that
    $[\xi_{j-1/2}^{\rm hot}, \xi_{j+1/2}^{\rm hot}]$ and $[\xi_{J-1/2}^{\rm RE},\xi_{J+1/2}^{\rm RE}]$
    overlap; equivalently all $J$ such that $\xi^{\rm RE}_{J-1/2}\leq\xi^{\rm hot}_{j+1/2}$
    and $\xi^{\rm RE}_{J+1/2}\geq\xi^{\rm hot}_{j-1/2}$.

    The advection coefficient $F^{\rm RE}_{1/2,J}$ is a free parameter here
    which we must now fix to maintain a conservative flux. We do this by
    considering the flux into a single cell on the runaway grid, instead of
    considering the flux into a single cell on the hot-tail grid as in
    equation~\eqref{eq:fluxBalance2}. This causes the sum over $J$ to cover
    exactly one element, so that $\overline{\Delta\xi}_{jJ}^{\rm RE}\to\Delta\xi_J^{\rm RE}$,
    and it causes a sum over $j$ to appear, although depending on how many cells
    the RE cell in question is actually connected to on the hot-tail grid, it
    may only range over one index (and the corresponding
    $\overline{\Delta\xi}_{jJ}$ may be less than $\Delta\xi^{\rm hot}_j$). We
    obtain
    \begin{equation}
        \sum_j \left( Ff \right)^{\rm hot}_{N_p+1/2,j} \Vp^{\rm hot}_{N_p+1/2,j} \overline{\Delta\xi}_{jJ} =
        \left( F f \right)^{\rm RE}_{1/2,J} \Delta\xi^{\rm RE}_J\Vp^{\rm RE}_{1/2,J}.
    \end{equation}
    Next, we plug in the expression for
    $f^{\rm hot}_{N_p+1,j}$~\eqref{eq:fhotTransf} (only considering the
    $f^{\rm hot}_{N_p+1,j}$ part in equation~\eqref{eq:PhiPhot} now, which is
    associated with $f^{\rm RE}_{1,J}$; the term for $f^{\rm hot}_{N_p,j}$ can be
    evaluated without problem on the hot-tail grid) and obtain the equality
    \begin{equation}\label{eq:advBalance}
        F^{\rm RE}_{1/2,J} f^{\rm RE}_{1,J} \Delta\xi^{\rm RE}_J\Vp^{\rm RE}_{1/2,J} =
        f_{1,J}^{\rm RE}\Delta\xi^{\rm RE}_J\Vp^{\rm RE}_{1/2,J}
        \sum_j F^{\rm hot}_{N_p+1/2,j} \frac{\overline{\Delta\xi}^{\rm hot}_{jJ}\Vp^{\rm hot}_{N_p+1/2,j}}
        {\Delta\xi^{\rm hot}_j\Vp^{\rm hot}_{N_p+1/2,j}},
    \end{equation}
    where we used that the sum over $j$ is such that it covers exactly one
    cell on the RE grid (exactly one $J$ index), and pulled the terms only
    depending on $J$ through the summation. From~\eqref{eq:advBalance} we can
    solve for the advection coefficient and obtain
    \begin{equation}\label{eq:avAdvection}
        F_{1/2,J}^{\rm RE} = \sum_j F^{\rm hot}_{N_p+1/2,j}
        \frac{\overline{\Delta\xi}^{\rm hot}_{jJ}}{\Delta\xi_j^{\rm hot}}.
    \end{equation}
    This is a weighted average of $F^{\rm hot}$ along the $\xi$ boundary
    adjacent to the RE cell considered.

    While this is all well, we should now also verify that the scheme will
    indeed conserve particles. We can do this by considering the fluxes as they
    are implemented on the hot-tail and runaway grids separately. On the
    hot-tail grid, we have
    \begin{equation}\label{eq:PhiPhot2}
        \Phi^{(p),{\rm hot}}_j = F^{\rm hot}_{N_p+1/2,j} \left[
            \left( 1-\delta^{\rm hot}_{N_p+1}\right)f^{\rm hot}_{N_p,j} +
            \frac{\delta^{\rm hot}_{N_p+1}}{\Delta\xi^{\rm hot}_j\Vp^{\rm hot}_{N_p+1/2,j}} \sum_J
                f_{1,J}^{\rm RE} \Vp^{\rm RE}_{1/2,J} \overline{\Delta\xi}_{jJ}^{\rm RE}
        \right],
    \end{equation}
    while on the runaway grid we instead have
    \begin{equation}\label{eq:PhiPRE}
        \begin{aligned}
            \Phi^{(p),{\rm RE}}_J &= F^{\rm RE}_{1/2,J} \left[
                \left( 1-\delta^{\rm hot}_{N_p+1} \right)f^{\rm RE}_{0,J} +
                \delta^{\rm hot}_{N_p+1} f^{\rm RE}_{1,J}
            \right],\\
            %
            %&= F^{\rm RE}_{1/2,J} \left[
            %    \frac{1-\delta^{\rm hot}_{N_p+1}}{\Delta\xi^{\rm RE}_J\Vp^{\rm RE}_{1/2,J}} \sum_j
            %        f_{N_p,j}^{\rm hot} \Vp^{\rm hot}_{N_p+1/2,j} \overline{\Delta\xi}_{jJ}^{\rm hot} +
            %    \delta^{\rm hot}_{N_p+1} f^{\rm RE}_{1,J}
            %\right],
        \end{aligned}
    \end{equation}
    To preserve particles, we must consider the first term as a unit, so that
    \begin{equation}
        F_{1/2,J}^{\rm RE} f_{0,J}^{\rm RE} \to
        \frac{1}{\Delta\xi^{\rm RE}_J\Vp^{\rm RE}_{1/2,J}} \sum_j
            F_{N_p+1/2,j}^{\rm hot}f_{N_p,j}^{\rm hot}
            \Vp^{\rm hot}_{N_p+1/2,j} \overline{\Delta\xi}_{jJ}^{\rm hot}.
    \end{equation}
    Doing so, and utilizing the expression~\eqref{eq:avAdvection} for the second
    term, we obtain
    \begin{equation}
        \Phi^{(p),{\rm RE}}_J =
            \frac{1-\delta^{\rm hot}_{N_p+1}}{\Delta\xi^{\rm RE}_J\Vp^{\rm RE}_{1/2,J}} \sum_j
                F_{N_p+1/2,j}f_{N_p,j}^{\rm hot}
                \Vp^{\rm hot}_{N_p+1/2,j} \overline{\Delta\xi}_{jJ}^{\rm hot} +
            \delta^{\rm hot}_{N_p+1} f^{\rm RE}_{1,J}
            \sum_j F^{\rm hot}_{N_p+1/2,j}
            \frac{\overline{\Delta\xi}^{\rm hot}_{jJ}}{\Delta\xi_j^{\rm hot}}.
    \end{equation}
    Finally, using~\eqref{eq:fluxCross} and summing over $J$ (in order for the
    sums over $j$ to only range over exactly one index on the hot-tail grid), we
    find that
    \begin{equation}
        \begin{gathered}
            \sum_J \Phi^{(p),{\rm RE}}_{J} \Vp^{\rm RE}_{1/2,J} \overline{\Delta\xi}_{jJ}^{\rm RE} =\\
             %
             = F_{N_p+1/2,j}\left[
                 \left( 1-\delta^{\rm hot}_{N_p+1} \right)
                 f^{\rm hot}_{N_p,j}
                 \Vp^{\rm hot}_{N_p+1/2,j}\Delta\xi_j^{\rm hot}
                 +
                 \delta^{\rm hot}_{N_p+1}\sum_J f_{1,J}^{\rm RE}\Vp^{\rm RE}_{1/2,J}
                 \overline{\Delta\xi}^{\rm RE}_{jJ}
             \right] =\\
             = \Phi^{(p),{\rm hot}}_{j} \Vp^{\rm hot}_{N_p+1/2,j}\Delta\xi^{\rm hot}_j.
        \end{gathered}
    \end{equation}
    Comparison with~\eqref{eq:PhiPhot2}, and use of a ``reversed'' form of
    equation~\eqref{eq:fluxCross}, shows that the fluxes are in agreement, and
    thus that the scheme proposed conserves the particle number.

\begin{comment}
    \red{Crap below here}

    \begin{equation}\label{eq:crossFlux_FRE}
        F^{\rm RE}_{1/2,J} =
            \Delta\xi_J^{\rm RE}\Vp^{\rm RE}_{1/2,J}
            \sum_j \frac{F_{N_p,j}^{\rm hot}}
                {\overline{\Delta\xi}_{jJ}^{\rm hot}\Vp^{\rm hot}_{N_p+1/2,j}}
    \end{equation}
    We will now show that this averaging procedure respects the conservation
    properties of the scheme.

   % Consider the flux~\eqref{eq:crossFluxP} on the hot-tail grid:
    \begin{equation}
        \Phi^{(p),{\rm hot}}_j = F^{\rm hot}_{N_p+1/2,j} \left[
            \left( 1-\delta^{\rm hot}_{N_p+1}\right)f^{\rm hot}_{N_p,j} +
            \frac{\delta^{\rm hot}_{N_p+1}}{\Delta\xi^{\rm hot}_j\Vp^{\rm hot}_{N_p+1/2,j}} \sum_J
                f_{1,J}^{\rm RE} \Vp^{\rm RE}_{1/2,J} \overline{\Delta\xi}_{jJ}^{\rm RE},
        \right]
    \end{equation}
    On the runaway grid, we instead have
    \begin{equation}
        \begin{aligned}
            \Phi^{(p),{\rm RE}}_J &= F^{\rm RE}_{1/2,J} \left[
                \left( 1-\delta^{\rm hot}_{N_p+1} \right)f^{\rm RE}_{0,J} +
                \delta^{\rm hot}_{N_p+1} f^{\rm RE}_{1,J}
            \right],\\
            %
            &= F^{\rm RE}_{1/2,J} \left[
                \frac{1-\delta^{\rm hot}_{N_p+1}}{\Delta\xi^{\rm RE}_J\Vp^{\rm RE}_{1/2,J}} \sum_j
                    f_{N_p,j}^{\rm hot} \Vp^{\rm hot}_{N_p+1/2,j} \overline{\Delta\xi}_{jJ}^{\rm hot} +
                \delta^{\rm hot}_{N_p+1} f^{\rm RE}_{1,J}
            \right],
        \end{aligned}
    \end{equation}
    where we used equation~\eqref{eq:crossFlux_fRE0}. Now inserting the
    expression~\eqref{eq:crossFlux_FRE} for $F_{1/2,J}^{\rm RE}$

    \begin{equation}
        \begin{gathered}
            \left( Ff \right)_j = F^{\rm hot}_{N_p+1/2,j} \left[
                \frac{1}{\Delta\xi^{\rm hot}_j\Vp^{\rm hot}_{N_p+1/2,j}} \sum_J
                    f_{1,J}^{\rm RE} \Vp^{\rm RE}_{1/2,J} \overline{\Delta\xi}_{jJ}^{\rm RE},
            \right]\\
            \left( Ff \right)_J =
            \sum_j \left[ F^{\rm hot}_{N_p+1/2,j}
                \frac{1}{\overline{\Delta\xi}^{\rm hot}_j\Vp^{\rm hot}_{N_p+1/2,j}}
            \right]
                    f_{1,J}^{\rm RE} \Vp^{\rm RE}_{1/2,J} \Delta\xi_{J}^{\rm RE},
            \\
        \end{gathered}
    \end{equation}
\end{comment}

    \subsubsection{Boundary conditions on $p_\parallel / p_\perp$ grid}
    \emph{To be written...}

    \subsection{Diffusion term}\label{sec:diffusion}
    A general diffusion term can be written on the form
    \begin{equation*}
        \nabla\cdot\left( \mathbb{D}\cdot\nabla f \right),
    \end{equation*}
    where $\mathbb{D}$ is the diffusion tensor
    \begin{equation*}
        \mathbb{D} = \begin{pmatrix}
            D_{rr} & D_{r1} & D_{r2} \\
            D_{1r} & D_{11} & D_{12} \\
            D_{2r} & D_{21} & D_{22}
        \end{pmatrix}.
    \end{equation*}
    In \DREAM, we neglect the radial cross-terms, i.e.\
    $D_{r1} = D_{1r} = D_{r2} = D_{2r} = 0$.

    For the diffusion term, we will need to approximate derivatives of the
    distribution function $f$. For the diagonal terms (i.e.\ the $D_{rr}$,
    $D_{11}$ and $D_{22}$ terms), this is straightforward: since the derivatives
    should be evaluated on the flux grid, we can use a basic central difference
    approximation:
    \begin{align}
        \left.\frac{\partial f}{\partial r}\right|_{k-1/2,i,j} &=
            \frac{f_{k,i,j} - f_{k-1,i,j}}{\Delta r_{k-1/2}},\\
        %
        \left.\frac{\partial f}{\partial p_1}\right|_{k,i-1/2,j} &=
            \frac{f_{k,i,j} - f_{k,i-1,j}}{\Delta p_{1; i-1/2}},\\
        %
        \left.\frac{\partial f}{\partial p_2}\right|_{k,i,j-1/2} &=
            \frac{f_{k,i,j} - f_{k,i,j-1}}{\Delta p_{2; j-1/2}},\\
    \end{align}
    Since no interpolation in $f$ is needed, these terms automatically preserve
    the positivity of the solution.

    The cross terms cause some problems with preservation of positivity.
    Unfortunately we cannot use the same interpolation scheme as for the
    advection term. To easily support the use of diffusion cross terms, we
    therefore use simple cell averaging, which does \emph{not} preserve
    positivity. We write the derivatives as
    \begin{equation}
        \begin{aligned}
            \left.\frac{\partial f}{\partial p_1}\right|_{k,i,j-1/2} &=
                \frac{f_{i+1,j} + f_{i+1,j-1} - f_{i-1,j} - f_{i-1,j-1}}
                {\Delta p_{1;i+1/2} + \Delta p_{1;i-1/2}},\\
            %
            \left.\frac{\partial f}{\partial p_2}\right|_{k,i-1/2,j} &=
                \frac{f_{i,j+1} + f_{i-1,j+1} - f_{i,j-1} - f_{i-1,j-1}}
                {\Delta p_{2;j+1/2} + \Delta p_{2;j-1/2}}.
        \end{aligned}
    \end{equation}
    If we would like to also preserve positivity, we should instead use the
    approach taken by refs.~\cite{DuToit2018,Daniel2019}. They rewrite the
    diffusion cross terms as advection terms, which allows us to use the same
    methods as in section~\ref{sec:advection}. The ``advection form'' for the
    diffusion cross terms is
    \begin{equation}
        \begin{aligned}
            \left[ D_{12}\frac{\partial f}{\partial p_2} \right] &=
                \frac{\partial (\ln f)}{\partial p_2}D_{12} f = \tilde{D}_{12} f,\\
            %
            \left[ D_{21}\frac{\partial f}{\partial p_1} \right] &=
                \frac{\partial (\ln f)}{\partial p_1}D_{21} f = \tilde{D}_{21} f,
        \end{aligned}
    \end{equation}
    where we have introduced the modified diffusion coefficients
    $\tilde{D}_{12}\equiv D_{12}\partial(\ln f)/\partial p_2$ and
    $\tilde{D}_{21}\equiv D_{21}\partial(\ln f)/\partial p_1$. These modified
    diffusion coefficients depend on (non-linearly) on the unknown, and hence
    they require a non-linear solver. We choose not to implement this form of
    the diffusion coefficients directly in the \DREAM/\FVM\ library, but instead
    refer to the physicist to rewriting her equations according to the above
    and implement them using the advection term class instead.

    \paragraph{Full discretisation}
    Within the framework of the finite-volume method, we discretise the general
    diffusion term as
    \begin{equation}
        \begin{aligned}
            \left[ \nabla\cdot\left( \mathbb{D}\cdot\nabla f \right) \right]_{kij} &=
                \frac{1}{\Vp_{i_1\cdots i_D}}\Bigg[\\
                %
                &\frac{1}{\Delta r_k}\left(
                    \Vp_{k+1/2}D_{rr;k+1/2}\frac{f_{k+1,i,j}-f_{k,i,j}}{\Delta r_{k+1/2}} -
                    \Vp_{k-1/2}D_{rr;k-1/2}\frac{f_{k,i,j}-f_{k-1,i,j}}{\Delta r_{k-1/2}}
                \right) +\\
                %
                &+ \frac{1}{\Delta p_{1;i}} \left(
                    \Vp_{i+1/2}D_{11;i+1/2}\frac{f_{k,i+1,j} - f_{k,i,j}}{\Delta p_{1;i+1/2}} -
                    \Vp_{i-1/2}D_{11;i-1/2}\frac{f_{k,i,j} - f_{k,i-1,j}}{\Delta p_{1;i-1/2}}
                \right) +\\
                %
                &+ \frac{1}{\Delta p_{2;i}} \left(
                    \Vp_{j+1/2}D_{22;j+1/2}\frac{f_{k,i,j+1} - f_{k,i,j}}{\Delta p_{2;j+1/2}} -
                    \Vp_{j-1/2}D_{22;j-1/2}\frac{f_{k,i,j} - f_{k,i,j-1}}{\Delta p_{2;j-1/2}}
                \right) +\\
                %
                &+ \Vp_{i+1/2}D_{12;i+1/2}\frac{
                    f_{k,i+1,j+1} + f_{k,i,j+1} - f_{k,i+1,j-1} - f_{k,i,j-1}
                }{\Delta p_{1;i}\left(\Delta p_{2;j+1/2} + \Delta p_{2;j-1/2} \right)} -\\
                &- \Vp_{i-1/2}D_{12;i-1/2}\frac{
                    f_{k,i,j+1} + f_{k,i-1,j+1} - f_{k,i,j-1} - f_{k,i-1,j-1}
                }{\Delta p_{1;i}\left(\Delta p_{2;j+1/2} + \Delta p_{2;j-1/2} \right)} +\\
                %
                &+ \Vp_{j+1/2}D_{21;j+1/2}\frac{
                    f_{k,i+1,j+1} + f_{k,i+1,j} - f_{k,i-1,j+1} - f_{k,i-1,j}
                }{\Delta p_{2;j}\left(\Delta p_{1;i+1/2} + \Delta p_{1;i-1/2} \right)} -\\
                &- \Vp_{j-1/2}D_{21;j-1/2}\frac{
                    f_{k,i+1,j} + f_{k,i+1,j-1} - f_{k,i-1,j} - f_{k,i-1,j-1}
                }{\Delta p_{2;j}\left(\Delta p_{1;i+1/2} + \Delta p_{1;i-1/2} \right)}\\
            &\Bigg].
        \end{aligned}
    \end{equation}

	\subsubsection{Boundary conditions on $p/\xi$ grid}
	\ldots

    \section{Interpolating in distribution function}\label{sec:interp}
    In advection terms, as well as diffusion cross terms, we must evaluate the
    distribution function on the flux grid. Since the distribution function is
    only explicitly computed on the cell grid, this means that we must
    interpolate in the distribution function. A simple scheme is provided by 
    linear interpolation, for which one can generally write
    \begin{equation}
        f_{i-1/2} = \delta_{i} f_i + \left( 1 - \delta_i \right) f_{i-1}.
    \end{equation}
    In the simplest approach with uniform grids, we take $\delta_i\equiv 1/2$, making $f_{i-1/2}$
    a simple average of the value of $f$ in the adjacent cells. While simple and
    often accurate enough, other schemes for choosing $\delta_i$ can provide
    better stability and even desirable physical properties such as preservation
    of positivity. These schemes are referred to as ``flux limiter schemes'',
    and we also provide those in the code.
    
    For additional flexibility and accuracy, we consider general 4-point stencils of the form
    \begin{equation}
    	f_{i-1/2} = \sum_{k=-2}^1 \delta^{(i)}_k f_{i+k}.
    \end{equation}
    In order to improve numerical stability and reduce oscillations, schemes with 
    upwind bias are advantageous where $\delta_{1}$ vanishes for positive 
    advection coefficients, and $\delta_{-2}$ for negative advection. In what follows,
    we will assume a positive advection coeffient $A_{i-1/2}>0$. For the $A_{i-1/2}<0$ 
    case, all interpolation coefficients will be mirrored, and can be obtained with the 
    mapping $k \mapsto -1 - k$.
    
    A general second-order accurate scheme can be generated from the so-called
    $\kappa$ schemes (given here for uniform grids, but are implemented more generally):
    \begin{align*}
    \delta_{-2} &= -\frac{1-\kappa}{4}, \nonumber \\
    \delta_{-1} &= 1 - \frac{\kappa}{2}, \nonumber \\
    \delta_0 &= \frac{1+\kappa}{4}, \nonumber \\
    \delta_1 &= 0.
    \end{align*}
    Here, $\kappa = 1$ corresponds to the linear interpolation (central difference) 
    scheme described above; since it has no upwind bias, it is less stable than other 
    $\kappa$ schemes. A common choice is $\kappa=0.5$ which yields the QUICK 
    scheme (which is the only choice of $\kappa$ that also gives third-order accuracy) 
    or $\kappa=-1$ which yields a purely upwind linear-extrapolation scheme (Second-order upwind).

    \subsection{Flux limiter schemes}
    The previous scheme, which is classified as linear since the interpolation 
    coefficients $\delta_k$ are independent of the solution, can be generalised to a 
    useful class of non-linear \emph{flux-limiter schemes}, which are given by
    (again specialising to uniform grids for compactness)
    \begin{align}
    \delta^{(i)}_{-2} &= -\frac{\psi(r^{(i)})}{2}, \nonumber \\
    \delta^{(i)}_{-1} &= 1 + \frac{\psi(r^{(i)})}{2}, \nonumber \\
    \delta^{(i)}_{0} &= 0, \nonumber \\
    \delta^{(i)}_{1} &= 0, \nonumber \\
    r^{(i)} &= \frac{f_i - f_{i-1}}{f_{i-1}-f_{i-2}}.
    \end{align}
    Via the function $\psi(r)$, the interpolation coefficients depend non-linearly on 
    the distribution $f$. Although it is not explicitly written on that form, the linear $\kappa$ schemes 
    are exactly retrieved with $\psi(r) = (1+\kappa)r/2 + (1-\kappa)/2$ (by comparing the net $f_{i-1/2}$ 
    obtained after interpolating). It can be shown that positivity preservation (or the more strict condition 
    of \emph{boundedness}, where $f_{i-1} \leq f_{i-1/2} \leq f_i$)
    will be satisfied by letting $\psi$ obey certain constraints.
    
    Three flux limiters that are implemented in DREAM are:
    \begin{align}
    \psi(r) &= \text{max}(0,\,\text{min}(2r,\,(1+3r)/4,\,4)), && \text{(SMART)} \nonumber \\
    \psi(r) &= \text{max}(0,\,\text{min}(2r,\,(1+r)/2,\,2)), && \text{(MUSCL)} \nonumber \\
    \psi(r) &= \frac{3}{2}\frac{r(1+r)}{r^2+r+1}. && \text{(OSPRE)}
    \end{align}
    For Dreicer generation, all three flux limiters give comparable accuracy, but OSPRE is the 
    more robust one thanks to its continuous form. 
    In some situations, convergence of the piece-wise flux limiters may be accelerated (or restored)
    by under-relaxing the algorithm, which we do by updating
    \begin{align}
    \delta = \delta_\text{prev} + \eta [\delta_\text{calc} - \delta_\text{prev}],
    \end{align}
    where $\eta \in [0,1]$ is a damping factor, $\delta_\text{calc}$ the interpolation coefficient
    according to the scheme chosen and $\delta_\text{prev}$ the coefficient in the previous iteration 
    of the non-linear solver. Sometimes a value of $\eta \approx 0.9$ is sufficient -- too low
    values can prevent convergence altogether.
    
    The accuracy of the interpolation schemes are compared in figure \ref{fig:advection interpolation convergence}.
    The first-order upwind scheme is outside of view as it significantly overpredicts the generation. Computation times 
    are not indicated, but the linear 2-point stencils Centered and UPWIND are fastest, then the linear 3-point stencils 
    QUICK and second-order upwind (UPWIND-2), and finally the flux limiters which are all significantly slower since 
    they require the non-linear solver to be used.
    
    \begin{figure}
    \begin{center}
    \includegraphics[width=1.0\textwidth,trim=25mm 0 25mm 0]{advection_interpolation_convergence}
    \caption{\label{fig:advection interpolation convergence} Runaway rate $\partial n_\mathrm{RE}/\partial t$ in 
    a basic Dreicer runaway scenario with parameters: $n_e = 5\times 10^{19}\,$m$^{-3}$, $T_e = 100\,$eV, $Z=1$, 
    $E=6.74546\,$V/m, run for $t_\mathrm{max}=1$\,ms in 10 time steps, with a grid extending to 
    $p_\mathrm{max} = 2m_e c$ with boundary condition $f(p_\mathrm{max})=0$ .}
    \end{center}
    \end{figure}
    \section{Solution of non-linear system}
    The set of equations we aim to solve can generally be formulated as the
    root-finding problem,
    \begin{equation}\label{eq:nonlinear}
        \bb{F}(\bb{x}) = 0,
    \end{equation}
    where $\bb{F}$ represents the physical equations to solve. A number of
    approaches could be imagined for solving this equation, and in this section
    we will review those implemented in \DREAM.

    \subsection{Linearly implicit solution}
    The linearly implicit solution method relies on the slow time evolution of
    the system in question. Let us assume that $\bb{F}$ may be decomposed into
    \begin{equation}
        \bb{F}\left( \bb{x} \right) = M\left( \bb{x} \right) \bb{x} + S\left( \bb{x} \right)
    \end{equation}
    where $M$ takes the form of a linear operator which may depend non-linearly
    on $\bb{x}$, and $S$ takes the form of a source term. In a linearly implicit
    scheme, one assumes that $M$ and $S$ depend weakly on $\bb{x}$, thus
    justifying the approximation
    \begin{equation}
        \bb{F}\left( \bb{x}_{n+1} \right)\approx M\left( \bb{x}_n\right) \bb{x}_{n+1}
        + S\left( \bb{x}_n \right).
    \end{equation}
    In this approximation, equation~\eqref{eq:nonlinear} may be solved by
    inverting the matrix $M$:
    \begin{equation}
        \bb{x}_{n+1} = M^{-1}\left(\bb{x}_n\right) S\left(\bb{x}_n\right).
    \end{equation}
    In contrast to the more accurate Newton method, the linearly implicit scheme
    requires no iteration, and thus only one matrix inversion. This can make the
    scheme beneficial for evolving systems which vary slowly in time.
    
    \subsection{Newton's method}
    The more general \emph{Newton's method} is obtained by Taylor expanding
    equation~\eqref{eq:nonlinear} around $\bb{x}^{(k+1)} = \bb{x}^{(k)} + \Delta\bb{x}$:
    \begin{equation}
        \bb{F}\left( \bb{x}^{(k+1)} \right)\approx \bb{F}\left(\bb{x}^{(k)}\right) +
        \Jac\left(\bb{x}^{(k)}\right) \left( \bb{x}^{(k+1)} - \bb{x}^{(k)} \right) = 0.
    \end{equation}
    Here, $\Jac(\bb{x}^{(k)}) = \partial\bb{F}(\bb{x}^{(k)})/\partial\bb{x}$
    denotes the Jacobian matrix of $\bb{F}$. Solving for $\bb{x}^{(k+1)}$, we
    obtain the iterative scheme
    \begin{equation}
        \bb{x}^{(k+1)} = \bb{x}^{(k)} - \Jac^{-1}\left( \bb{x}^{(k)} \right) \bb{F}\left( \bb{x}^{(k)} \right),
    \end{equation}
    which hopefully converges to the true zero of $\bb{F}$. Here, we thus rely
    on a series of iterations to obtain the true solution in any given time
    step.

    The most difficult part of Newton's method is evaluating the Jacobian
    $\Jac$.

    \addcontentsline{toc}{section}{References}
    \printbibliography

\end{document}

